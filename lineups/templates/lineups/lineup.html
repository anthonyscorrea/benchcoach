{% extends 'base.html' %}{% block title %} {{ title }} {% endblock %}{% load crispy_forms_tags %}

{% block content %}
    <h1>{{ title }}</h1>
    {{ event.away_team.name }} vs. {{ event.home_team.name }} <br>
    {{ event.start|date:"l, F j, Y g:i A" }} <br>
    {{ event.venue.name }} <br>
    <div class="container">
        <div class="row">
            <form action="{%  url 'edit lineup' event_id=event.id%}" method="post">

            <div class="col-md-6">
                <h5>Lineup</h5>
                    <table class="table">
                        <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Player</th>
                            <th scope="col">Position</th>
                        </tr>
                        </thead>
                        <tbody  id="lineup">
                        {#{% for player in positionings_players_initial|dictsort:"positioning.order" %}#}
                        {% csrf_token %}
                        {{ formset_starting.management_form }}
                            {% for form in formset_starting %}
                                <tr data-player-id="{{ player.id }}",
                                    data-positioning-position="{{ form.instance.player.positioning.position }}"
                                >
                                    {#                            <th scope="row">{{ form.order }}</th>#}
                                    {#                            <td>{{ form.player }}</td>#}
                                    {#                            <td>{{ form.position }}</td>#}
                                    <th scope="row">{% if form.instance.order %}{{ form.instance.order }}{% endif %}</th>
                                    <th>{{ form.instance.player.first_name }} {{ form.instance.player.last_name }}</th>
                                    <td>{{ form.instance.position }}</td>

                                </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {#                    {% endfor %}#}
                    <input type="submit" value="Submit">
                </form>
            </div>

            <div class="col-md-6">
                <h5>Players</h5>
                <div class="col-md-6">
                    <table class="table">
                        <tr>
                            <th scope="col"></th>
                            <th scope="col">Name</th>
                            <th scope="col">#</th>
                            <th scope="col">Statline</th>
                        </tr>
                        <tbody id="bench">
                        {% for form in formset_bench %}
                            {% if not player.positioning.order and not player.positioning.position == "P"  %}
                                <tr data-player-id="{{ pos.player.id }}">
                                    <td>
                                        {% if pos.player.availability.available == 2 %}
                                            <img class="bg-success p-2 rounded-circle" width="5" height="5"><span class="visually-hidden">Yes</span></img>
                                        {% elif pos.player.availability.available == 1%}
                                            <img class="bg-info p-2 rounded-circle" width="5" height="5"><span class="visually-hidden">Maybe</span></span>
                                        {% elif pos.player.availability.available == 0%}
                                            <img class="bg-danger p-2 rounded-circle" width="5" height="5"><span class="visually-hidden">No</span></span>
                                        {% elif pos.player.availability.available == -1%}
                                            <img class="bg-secondary p-2 rounded-circle" width="5" height="5"><span class="visually-hidden">Unknown</span></span>
                                        {% endif %}
                                    </td>
                                    <th><span class="d-none d-md-block" id="player-name-{{ form.instance.player.id }}">{{ form.instance.player.first_name }}</span> {{ form.instance.player.last_name }}</th>
                                    <td id="player-jersey-number-{{ form.instance.player.id }}">{{ form.instance.player.jersey_number }} </td>
                                    <td id="player-statline-{{ form.instance.player.player.id }}"><code>{{ form.instance.player.statline}}</code></td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                        </tbody>
                    </table >
                </div>
            </div>
        </div>
    </div>
    <script src="https://raw.githack.com/SortableJS/Sortable/master/Sortable.js"></script>
    <script id="sortable">
        var lineup = new Sortable.create(
            document.getElementById('lineup'), {
                animation: 150,
                ghostClass:"ghost",
                {#handle: ".bars-move",#}
                group:{
                    put:true,
                    pull:true
                },
                onAdd: function (/**Event*/evt) {
                    console.log('added to lineup')
                    var itemEl = evt.item;  // dragged HTMLElement
                    var player_id = itemEl.dataset.playerId
                    var statline = document.querySelector('#player-statline-'+player_id);
                    {#console.log(itemEl)#}
                    {#console.log(player_id)#}
                    {#console.log(statline)#}
                    statline.style.visibility='hidden'
                    evt.to;    // target list
                    evt.from;  // previous list
                    evt.oldIndex;  // element's old index within old parent
                    evt.newIndex;  // element's new index within new parent
                    evt.oldDraggableIndex; // element's old index within old parent, only counting draggable elements
                    evt.newDraggableIndex; // element's new index within new parent, only counting draggable elements
                    evt.clone // the clone element
                    evt.pullMode;  // when item is in another sortable: `"clone"` if cloning, `true` if moving
                },
                onUpdate: function (/**Event*/evt) {
                    console.log('update to lineup')
                },
            });
        var bench = new Sortable.create(
            document.getElementById('bench'), {
                animation: 150,
                ghostClass:"ghost",
                {#handle: ".bars-move",#}
                group:{
                    put:true,
                    pull:true
                },
                onAdd: function (/**Event*/evt) {
                    console.log('added to bench')
                    var itemEl = evt.item;  // dragged HTMLElement
                    console.log(itemEl)
                    evt.to;    // target list
                    evt.from;  // previous list
                    evt.oldIndex;  // element's old index within old parent
                    evt.newIndex;  // element's new index within new parent
                    evt.oldDraggableIndex; // element's old index within old parent, only counting draggable elements
                    evt.newDraggableIndex; // element's new index within new parent, only counting draggable elements
                    evt.clone // the clone element
                    evt.pullMode;  // when item is in another sortable: `"clone"` if cloning, `true` if moving
                    var player_id = itemEl.dataset.playerId
                    var statline = document.querySelector('#player-statline-'+player_id);
                    {#console.log(itemEl)#}
                    {#console.log(player_id)#}
                    {#console.log(statline)#}
                    statline.style.visibility='visible'
                }
            });

    </script>

{% endblock %}